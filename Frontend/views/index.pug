extends layout

block content
  div.header_container
    div.search_banner
      img(src="/images/Magilogo.png", alt="MagiProf Logo", style="margin-left: 18%;")
      form#searchForm(action="/index" method="GET")
        input#searchInput(type="text" name="q" placeholder="Search cards..."
          value=query.searchQuery
          style="background: none; border: 0px; height: 50px;")

      p(style="margin-left: 24%;") |
      button(type=button onclick="window.location.href='/advanced'") Advanced
      button(type=button onclick="alert('Syntax guide coming soon')") Syntax
      button(type=button onclick="alert('All sets coming soon')") Sets
      button(type=button onclick="alert('Random card coming soon')") Random
      p(style="margin-left: 2%;") |

    div.sort_banner
      form#filterForm(action="/index" method="GET" style="width: wrap-content; margin-left: 18%;")
        input(type="hidden" name="q" value=query.searchQuery)

        label(for="ViewType")
        select#ViewType(name="view" onchange="this.form.submit()")
          option(value="cards" selected=(query.viewType === 'cards')) Cards
          option(value="all_prints" selected=(query.viewType === 'all_prints')) All Prints
          option(value="unique" selected=(query.viewType === 'unique')) Unique

        label(for="DisplayType")  as
        select#DisplayType(name="display" onchange="this.form.submit()")
          option(value="images" selected=(query.display === 'images')) Images
          option(value="checklist" selected=(query.display === 'checklist')) Checklist
          option(value="text" selected=(query.display === 'text')) Text Only
          option(value="full" selected=(query.display === 'full')) Full

        label(for="FilterType")  sorted by
        select#FilterType(name="sort" onchange="this.form.submit()")
          option(value="name" selected=(query.sortBy === 'name')) Name
          option(value="release_date" selected=(query.sortBy === 'release_date')) Release Date
          option(value="card_number" selected=(query.sortBy === 'card_number')) Set/Number
          option(value="year" selected=(query.sortBy === 'year')) Year

        label(for="SortType")  :
        select#SortType(name="order" onchange="this.form.submit()")
          option(value="asc" selected=(query.order === 'asc')) Ascending
          option(value="desc" selected=(query.order === 'desc')) Descending

      // Top pagination buttons
      button(type=button style="margin-left: 15%;" id="firstPageBtnTop") <<
      button(type=button id="prevPageBtnTop") < Previous
      span(style="margin: 0 10px; font-weight: bold;")
        | Page #{pagination.page || 1} of #{pagination.total_pages || 1}
      button(type=button id="nextPageBtnTop") Next >
      button(type=button id="lastPageBtnTop") >>

    div.result_banner
      if stats
        p Showing #{cards.length} of #{stats.total_cards} cards
      else
        p Loading results...

  div.full_screen
    if cards && cards.length > 0
      if query.display === 'checklist'
        table(style="width: 90%; margin: auto; border-collapse: collapse;")
          thead
            tr
              th(style="border-bottom: 1px solid #ccc; text-align: left; padding: 8px;") Name
              th(style="border-bottom: 1px solid #ccc; text-align: left; padding: 8px;") Type
              th(style="border-bottom: 1px solid #ccc; text-align: left; padding: 8px;") Year
          tbody
            each card in cards
              tr
                td(style="padding: 6px 8px;") #{card.card_name || card.name || 'Unknown'}
                td(style="padding: 6px 8px;") #{card.type1 || 'N/A'}
                td(style="padding: 6px 8px;") #{card.card_year || 'Unknown'}
      else if query.display === 'text'
        div(style="margin: 20px auto; width: 90%;")
          each card in cards
            div(style="border-bottom: 1px solid #ddd; padding: 10px; margin: 10px 0;")
              strong= card.card_name || card.name || 'Unknown'
              p= `Type: ${card.type1 || 'N/A'} | Year: ${card.card_year || 'Unknown'}`
              if card.flavor_text
                p(style="font-style: italic;")= card.flavor_text
      else if query.display === 'images'
        each card in cards
          - const imgPath = card.image_filepath ? `/${card.image_filepath}` : '/card_images/default-card.png'
          img(src=imgPath, alt=card.card_name || card.name, title=`${card.card_name || card.name}`, onerror="this.style.display='none'")
      else if query.display === 'full'
        each card in cards
          - const imgPath = card.image_filepath ? `/${card.image_filepath}` : '/card_images/default-card.png'
          div.card-wrapper
            img.card-image(src=imgPath, alt=card.card_name || card.name)
            .card-info
              strong= card.card_name || card.name
              p= `${card.type1 || 'N/A'} | ${card.card_year || 'Unknown'}`
      else
        each card in cards
          - const imgPath = card.image_filepath ? `/${card.image_filepath}` : '/card_images/default-card.png'
          img(src=imgPath, alt=card.card_name || card.name, title=`${card.card_name || card.name}`, onerror="this.style.display='none'")
    else
      p(style="grid-column: 1 / -1; text-align: center; padding: 40px;") No cards found


  script.
    // Real-time search
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        document.getElementById('searchForm').submit();
      }, 500);  // Wait 500ms after user stops typing
    });

  script.
      function sendWindowSize() {
        const width = window.innerWidth;
        const height = window.innerHeight;

        fetch('/window-size', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ width, height })
        }).catch(err => console.error('Failed to send window size:', err));
      }
      sendWindowSize();
      window.addEventListener('resize', () => {
        sendWindowSize();
      });

  script.
    document.addEventListener("DOMContentLoaded", function() {
      const currentPage = #{pagination.page || 1};
      const totalPages = #{pagination.total_pages || 1};
      const queryParams = new URLSearchParams(window.location.search);

      function goToPage(page) {
        queryParams.set("page", page);
        window.location.href = `/index?${queryParams.toString()}`;
      }

      function attachPaginationControls(prefix) {
        const first = document.getElementById(`firstPageBtn${prefix}`);
        const prev = document.getElementById(`prevPageBtn${prefix}`);
        const next = document.getElementById(`nextPageBtn${prefix}`);
        const last = document.getElementById(`lastPageBtn${prefix}`);

        if (first) first.addEventListener("click", () => { if (currentPage > 1) goToPage(1); });
        if (prev) prev.addEventListener("click", () => { if (currentPage > 1) goToPage(currentPage - 1); });
        if (next) next.addEventListener("click", () => { if (currentPage < totalPages) goToPage(currentPage + 1); });
        if (last) last.addEventListener("click", () => { if (currentPage < totalPages) goToPage(totalPages); });
      }

      attachPaginationControls("Top");
      attachPaginationControls("Bottom");
    });